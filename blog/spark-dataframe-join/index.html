<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>#9 DataFrame API#3: Join | SimoneDangelo Blog</title>
<meta name=keywords content="coding,spark,tutorial"><meta name=description content="Join in Spark."><meta name=author content="Me"><link rel=canonical href=https://simdangelo.github.io/blog/spark-dataframe-join/><link crossorigin=anonymous href=/assets/css/stylesheet.fc10a2e502c8379ca6fd0ccb1371d9d4049c0fd729db19019841464f9733f2ef.css integrity="sha256-/BCi5QLIN5ym/QzLE3HZ1AScD9cp2xkBmEFGT5cz8u8=" rel="preload stylesheet" as=style><link rel=icon href=https://simdangelo.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://simdangelo.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://simdangelo.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://simdangelo.github.io/apple-touch-icon.png><link rel=mask-icon href=https://simdangelo.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://simdangelo.github.io/blog/spark-dataframe-join/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="#9 DataFrame API#3: Join"><meta property="og:description" content="Join in Spark."><meta property="og:type" content="article"><meta property="og:url" content="https://simdangelo.github.io/blog/spark-dataframe-join/"><meta property="og:image" content="https://simdangelo.github.io/images/papermod-cover.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2024-05-04T00:00:00+00:00"><meta property="article:modified_time" content="2024-05-04T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://simdangelo.github.io/images/papermod-cover.png"><meta name=twitter:title content="#9 DataFrame API#3: Join"><meta name=twitter:description content="Join in Spark."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blogs","item":"https://simdangelo.github.io/blog/"},{"@type":"ListItem","position":2,"name":"#9 DataFrame API#3: Join","item":"https://simdangelo.github.io/blog/spark-dataframe-join/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"#9 DataFrame API#3: Join","name":"#9 DataFrame API#3: Join","description":"Join in Spark.","keywords":["coding","spark","tutorial"],"articleBody":"I think that this post will not be so useful for many people. Join is something that happens in many other scenarios in the data fields (directly in SQL for data analytics, in Pandas or Polars library for data analysis, etc.), so I’m sure that everyone reading this post is familiar with this topic. However, I decided to write this post just to complete the series on the most common functions found in the Spark DataFrame API.\nIt is very likely that this will be the last post specifically on the DataFrame API, not because the topics are exhausted, but because it would be pointless to continue to make a list of the functions found in the DataFrame API. In this series of posts we have discussed the most common functions and that is enough. There are dozens of other functions that can be used, but for that there is the Spark documentation that you can consult. This doesn’t mean we will not use DataFrame API anymore. My plan is to address some more specific topics in the future like Optimization and Fine-Tuning of Spark Jobs and talk about Internals of Spark.\n0. Resources “Spark Essentials with Scala” course by Daniel Ciocîrlan (link here: https://rockthejvm.com/p/spark-essentials) 1. Start the Project If you’re interested in learning how to create a new Spark project in Scala, refer to the initial blog post on Spark available at the following link: https://simdangelo.github.io/blog/run-spark-application/. In this guide, we utilize the same project that was used in previous tutorials and will continue to use in future ones. You can download this project from the following repository: https://github.com/simdangelo/apache-spark-blog-tutorial.\n2. Join Definition Joins are used to combine data from multiple DataFrames and the underlying principles of this practice are very simple:\none (or more) column from Table 1 (left) is compared with one (or more) column from Table 2 (right); if the condition passes, rows are combined; non-matching rows are discarded. In Spark Joins are wide transformations. In order to compute a join, Spark scans the entire DF across the entire cluster, so data is going to be moved around between various Spark nodes. So this involves shuffling, which is expensive for performance.\nThis is why I want to address topics like Optimization in the future: because joins can potentially degrade performance if not well managed.\n3. Types of Join Let’s create a new Scala file by creating a new Object (again look at this https://simdangelo.github.io/blog/run-spark-application/) and we call it Join.\nThen let’s start with the usual configuration:\nval spark = SparkSession.builder() .appName(\"Spark Joins\") .config(\"spark.master\", \"local[*]\") .getOrCreate() spark.sparkContext.setLogLevel(\"WARN\") In addition, add these import declarations to make the entire code we will write today work:\nimport org.apache.spark.sql.SparkSession Now let’s create three Spark DataFrames that we’ll use to perform joins:\nimport spark.implicits._ val bands = Seq( (1, \"AC/DC\", \"Sydney\", 1973), (0, \"Led Zeppelin\", \"London\", 1968), (3, \"Metallica\", \"Los Angeles\", 1981), (4, \"The Beatles\", \"Liverpool\", 1960) ) val bandsDF = bands.toDF(\"id\", \"name\", \"hometown\", \"year\") val guitars = Seq( (0, \"EDS-1275\", \"Gibson\", \"Electric double-necked\"), (5, \"Stratocaster\", \"Fender\", \"Electric\"), (1, \"SG\", \"Gibson\", \"Electric\"), (2, \"914\", \"Taylor\", \"Acoustic\"), (3, \"M-II\", \"ESP\", \"Electric\"), ) val guitarsDF = guitars.toDF(\"id\", \"model\", \"make\", \"guitarType\") val guitarists = Seq( (0, \"Jimmy Page\", Seq(0), 0), (1, \"Angus Young\", Seq(1), 1), (2, \"Eric Clapton\", Seq(1, 5), 2), (3, \"Kirk Hammett\", Seq(3), 3) ) val guitaristsDF = guitarists.toDF(\"id\", \"name\", \"guitars\", \"band\") Just to have better in mind these DFs, let’s show them:\nSpark supports these join types: ‘inner’, ‘outer’, ‘full’, ‘fullouter’, ‘full_outer’, ’leftouter’, ’left’, ’left_outer’, ‘rightouter’, ‘right’, ‘right_outer’, ’leftsemi’, ’left_semi’, ‘semi’, ’leftanti’, ’left_anti’, ‘anti’, ‘cross’.\nBefore introduction all types of join, let’s look at this graphical representation that explains better than any words:\nhttps://learn.microsoft.com/en-us/azure/data-explorer/kusto/query/join-operator?pivots=azuredataexplorer\" /\u003e Source: https://learn.microsoft.com/en-us/azure/data-explorer/kusto/query/join-operator?pivots=azuredataexplorer\nImportant note! Consider that I have taken this image because it was not easy to find an image on the web with all the types of joins I want to talk about, but note that Spark does not have joins called rightsemi, rightanti, innerunique.\n3.1. Left Join, Inner Join, Right Join Say we want to know to which band each guitarist belongs to, so we join guitarPlayersDF with the bandsDF based on the band id information. We’ll make left, right, and inner join sequentially:\n// condition val joinCondition = guitaristsDF.col(\"band\") === bandsDF.col(\"id\") // left join val guitaristsBandsDF_left = guitaristsDF.join(bandsDF, joinCondition, \"left\") // inner join val guitaristsBandsDF_inner = guitaristsDF.join(bandsDF, joinCondition, \"inner\") // right join val guitaristsBandsDF_right = guitaristsDF.join(bandsDF, joinCondition, \"right\") Without going into details, let’s define each join following the image above:\nLeft Join: combines rows from two tables based on a matching condition, including all rows from the left table and only matching rows from the right table. Any rows from the right table that don’t have a match are filled with NULL values; Inner Join: take only the things that match on the left AND the right; Right Join: take everything on the right + anything on the left that matches; Here’s the result:\nNote that:\nleft type is equivalent to left_outer and leftouter; right type is equivalent to right_outer and rightouter. 3.2. Full-Outer Join In Full outer join we’ll take everything in the inner join + all the rows in the BOTH table, with NULL where the data is missing:\nval guitaristsBandsDF_full_outer = guitaristsDF.join(bandsDF, joinCondition, \"full_outer\") Here’s the result:\nNote that:\nfull_outer type is equivalent to outer and fullouter and full. 3.3. Left-Semi Join It’s like an inner join, but it also cut out the columns from the RIGHT DataFrame:\nval guitaristsBandsDF_left_semi = guitaristsDF.join(bandsDF, joinCondition, \"left_semi\") Here’s the result:\nNote that:\nleft_semi type is equivalent to leftsemi and semi. 3.4. Left-Anti Join It keeps the rows in the LEFT DataFrame for which there is no row RIGHT DataFrame satisfying the join condition:\nval guitaristsBandsDF_left_anti = guitaristsDF.join(bandsDF, joinCondition, \"left_anti\") Here’s the result:\nNote that:\nleft_anti type is equivalent to leftanti and anti. 4. Potential Problems Let’s consider guitaristsBandsDF_left DataFrame and let’s show it again here to better understand the problem:\nIf we want to select only id and band (from left table):\nguitaristsBandsDF_left.select(\"id\", \"band\").show() we’ll got an error because after the join there will be two id columns.\nSolutions:\nrename the column on which we are joining so that the two keys has now the same name:\nval guitaristsBandsDF_left_v2 = guitaristsDF.join(bandsDF.withColumnRenamed(\"id\", \"band\"), \"band\", \"left\") drop the duplicate column after the join:\nval guitaristsBandsDF_left_v3 = guitaristsDF.join(bandsDF, joinCondition, \"left\").drop(bandsDF.col(\"id\")) rename the offending column before the join:\nval bandsModDF = bandsDF.withColumnRenamed(\"id\", \"bandId\") val guitaristsBandsDF_left_v4 = guitaristsDF.join(bandsModDF, guitaristsDF.col(\"band\")===bandsModDF.col(\"bandId\"), \"left\") ","wordCount":"1067","inLanguage":"en","image":"https://simdangelo.github.io/images/papermod-cover.png","datePublished":"2024-05-04T00:00:00Z","dateModified":"2024-05-04T00:00:00Z","author":[{"@type":"Person","name":"Me"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://simdangelo.github.io/blog/spark-dataframe-join/"},"publisher":{"@type":"Organization","name":"SimoneDangelo Blog","logo":{"@type":"ImageObject","url":"https://simdangelo.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://simdangelo.github.io/ accesskey=h title="SimoneDangelo Blog (Alt + H)">SimoneDangelo Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://simdangelo.github.io/archives title=Archive><span>Archive</span></a></li><li><a href=https://simdangelo.github.io/search/ title=Search><span>Search</span></a></li><li><a href=https://simdangelo.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://github.com/simdangelo title=GitHub><span>GitHub</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://simdangelo.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://simdangelo.github.io/blog/>Blogs</a></div><h1 class="post-title entry-hint-parent">#9 DataFrame API#3: Join</h1><div class=post-meta><span title='2024-05-04 00:00:00 +0000 UTC'>May 4, 2024</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Me</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#0-resources aria-label="0. Resources">0. Resources</a></li><li><a href=#1-start-the-project aria-label="1. Start the Project">1. Start the Project</a></li><li><a href=#2-join-definition aria-label="2. Join Definition">2. Join Definition</a></li><li><a href=#3-types-of-join aria-label="3. Types of Join">3. Types of Join</a><ul><li><a href=#31-left-join-inner-join-right-join aria-label="3.1. Left Join, Inner Join, Right Join">3.1. Left Join, Inner Join, Right Join</a></li><li><a href=#32-full-outer-join aria-label="3.2. Full-Outer Join">3.2. Full-Outer Join</a></li><li><a href=#33-left-semi-join aria-label="3.3. Left-Semi Join">3.3. Left-Semi Join</a></li><li><a href=#34-left-anti-join aria-label="3.4. Left-Anti Join">3.4. Left-Anti Join</a></li></ul></li><li><a href=#4-potential-problems aria-label="4. Potential Problems">4. Potential Problems</a></li></ul></div></details></div><div class=post-content><p>I think that this post will not be so useful for many people. <strong>Join</strong> is something that happens in many other scenarios in the data fields (directly in SQL for data analytics, in Pandas or Polars library for data analysis, etc.), so I&rsquo;m sure that everyone reading this post is familiar with this topic. However, I decided to write this post just to complete the series on the most common functions found in the Spark DataFrame API.</p><p>It is very likely that this will be the last post specifically on the DataFrame API, not because the topics are exhausted, but because it would be pointless to continue to make a list of the functions found in the DataFrame API. In this series of posts we have discussed the most common functions and that is enough. There are dozens of other functions that can be used, but for that there is the Spark documentation that you can consult. This doesn’t mean we will not use DataFrame API anymore. My plan is to address some more specific topics in the future like <strong>Optimization</strong> and <strong>Fine-Tuning</strong> of Spark Jobs and talk about <strong>Internals of Spark</strong>.</p><h1 id=0-resources>0. Resources<a hidden class=anchor aria-hidden=true href=#0-resources>#</a></h1><ul><li>“Spark Essentials with Scala” course by Daniel Ciocîrlan (link here: <a href=https://rockthejvm.com/p/spark-essentials>https://rockthejvm.com/p/spark-essentials</a>)</li></ul><h1 id=1-start-the-project>1. Start the Project<a hidden class=anchor aria-hidden=true href=#1-start-the-project>#</a></h1><p>If you&rsquo;re interested in learning how to create a new Spark project in Scala, refer to the initial blog post on Spark available at the following link: <a href=https://simdangelo.github.io/blog/run-spark-application/>https://simdangelo.github.io/blog/run-spark-application/</a>. In this guide, we utilize the same project that was used in previous tutorials and will continue to use in future ones. You can download this project from the following repository: <a href=https://github.com/simdangelo/apache-spark-blog-tutorial>https://github.com/simdangelo/apache-spark-blog-tutorial</a>.</p><h1 id=2-join-definition>2. Join Definition<a hidden class=anchor aria-hidden=true href=#2-join-definition>#</a></h1><p><strong>Joins</strong> are used to <strong>combine data from multiple DataFrames</strong> and the underlying principles of this practice are very simple:</p><ul><li>one (or more) column from Table 1 (left) is compared with one (or more) column from Table 2 (right);</li><li>if the condition passes, rows are combined;</li><li>non-matching rows are discarded.</li></ul><p>In Spark Joins are <strong>wide transformations</strong>. In order to compute a join, Spark scans the entire DF across the entire cluster, so data is going to be moved around between various Spark nodes. So this involves shuffling, which is <strong>expensive</strong> for performance.</p><p>This is why I want to address topics like Optimization in the future: because joins can potentially degrade performance if not well managed.</p><h1 id=3-types-of-join>3. Types of Join<a hidden class=anchor aria-hidden=true href=#3-types-of-join>#</a></h1><p>Let’s create a new Scala file by creating a new Object (again look at this <a href=https://simdangelo.github.io/blog/run-spark-application/>https://simdangelo.github.io/blog/run-spark-application/</a>) and we call it <code>Join</code>.</p><p>Then let’s start with the usual configuration:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>val</span> spark <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>SparkSession</span><span style=color:#f92672>.</span>builder<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>appName<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Spark Joins&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>config<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;spark.master&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;local[*]&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span>getOrCreate<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>spark<span style=color:#f92672>.</span>sparkContext<span style=color:#f92672>.</span>setLogLevel<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;WARN&#34;</span><span style=color:#f92672>)</span>
</span></span></code></pre></div><p>In addition, add these import declarations to make the entire code we will write today work:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>import</span> org.apache.spark.sql.SparkSession
</span></span></code></pre></div><p>Now let’s create three Spark DataFrames that we’ll use to perform joins:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>import</span> spark.implicits._
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> bands <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>Seq</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;AC/DC&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Sydney&#34;</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>1973</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>(</span><span style=color:#ae81ff>0</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Led Zeppelin&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;London&#34;</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>1968</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>(</span><span style=color:#ae81ff>3</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Metallica&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Los Angeles&#34;</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>1981</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>(</span><span style=color:#ae81ff>4</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;The Beatles&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Liverpool&#34;</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>1960</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> bandsDF <span style=color:#66d9ef>=</span> bands<span style=color:#f92672>.</span>toDF<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;name&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;hometown&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;year&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> guitars <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>Seq</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>(</span><span style=color:#ae81ff>0</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;EDS-1275&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Gibson&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Electric double-necked&#34;</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>(</span><span style=color:#ae81ff>5</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Stratocaster&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Fender&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Electric&#34;</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;SG&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Gibson&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Electric&#34;</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>(</span><span style=color:#ae81ff>2</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;914&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Taylor&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Acoustic&#34;</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>(</span><span style=color:#ae81ff>3</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;M-II&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;ESP&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Electric&#34;</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> guitarsDF <span style=color:#66d9ef>=</span> guitars<span style=color:#f92672>.</span>toDF<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;model&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;make&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;guitarType&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> guitarists <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>Seq</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>(</span><span style=color:#ae81ff>0</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Jimmy Page&#34;</span><span style=color:#f92672>,</span> <span style=color:#a6e22e>Seq</span><span style=color:#f92672>(</span><span style=color:#ae81ff>0</span><span style=color:#f92672>),</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Angus Young&#34;</span><span style=color:#f92672>,</span> <span style=color:#a6e22e>Seq</span><span style=color:#f92672>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>),</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>(</span><span style=color:#ae81ff>2</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Eric Clapton&#34;</span><span style=color:#f92672>,</span> <span style=color:#a6e22e>Seq</span><span style=color:#f92672>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>5</span><span style=color:#f92672>),</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>(</span><span style=color:#ae81ff>3</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Kirk Hammett&#34;</span><span style=color:#f92672>,</span> <span style=color:#a6e22e>Seq</span><span style=color:#f92672>(</span><span style=color:#ae81ff>3</span><span style=color:#f92672>),</span> <span style=color:#ae81ff>3</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> guitaristsDF <span style=color:#66d9ef>=</span> guitarists<span style=color:#f92672>.</span>toDF<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;name&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;guitars&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;band&#34;</span><span style=color:#f92672>)</span>
</span></span></code></pre></div><p>Just to have better in mind these DFs, let’s show them:</p><p><img loading=lazy src=images/Untitled.png alt=Untitled></p><p>Spark supports these join types: &lsquo;inner&rsquo;, &lsquo;outer&rsquo;, &lsquo;full&rsquo;, &lsquo;fullouter&rsquo;, &lsquo;full_outer&rsquo;, &rsquo;leftouter&rsquo;, &rsquo;left&rsquo;, &rsquo;left_outer&rsquo;, &lsquo;rightouter&rsquo;, &lsquo;right&rsquo;, &lsquo;right_outer&rsquo;, &rsquo;leftsemi&rsquo;, &rsquo;left_semi&rsquo;, &lsquo;semi&rsquo;, &rsquo;leftanti&rsquo;, &rsquo;left_anti&rsquo;, &lsquo;anti&rsquo;, &lsquo;cross&rsquo;.</p><p>Before introduction all types of join, let’s look at this graphical representation that explains better than any words:</p><p><img loading=lazy src=images/join-kinds.png alt='<a href="https://learn.microsoft.com/en-us/azure/data-explorer/kusto/query/join-operator?pivots=azuredataexplorer">https://learn.microsoft.com/en-us/azure/data-explorer/kusto/query/join-operator?pivots=azuredataexplorer</a>'></p><p><em>Source: <a href="https://learn.microsoft.com/en-us/azure/data-explorer/kusto/query/join-operator?pivots=azuredataexplorer">https://learn.microsoft.com/en-us/azure/data-explorer/kusto/query/join-operator?pivots=azuredataexplorer</a></em></p><p>Important note! Consider that I have taken this image because it was not easy to find an image on the web with all the types of joins I want to talk about, but note that Spark does not have joins called rightsemi, rightanti, innerunique.</p><h2 id=31-left-join-inner-join-right-join>3.1. Left Join, Inner Join, Right Join<a hidden class=anchor aria-hidden=true href=#31-left-join-inner-join-right-join>#</a></h2><p>Say we want to know to which band each guitarist belongs to, so we join <code>guitarPlayersDF</code> with the <code>bandsDF</code> based on the band id information. We’ll make left, right, and inner join sequentially:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#75715e>// condition
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>val</span> joinCondition <span style=color:#66d9ef>=</span> guitaristsDF<span style=color:#f92672>.</span>col<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;band&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>===</span> bandsDF<span style=color:#f92672>.</span>col<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// left join
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>val</span> guitaristsBandsDF_left <span style=color:#66d9ef>=</span> guitaristsDF<span style=color:#f92672>.</span>join<span style=color:#f92672>(</span>bandsDF<span style=color:#f92672>,</span> joinCondition<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;left&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// inner join
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>val</span> guitaristsBandsDF_inner <span style=color:#66d9ef>=</span> guitaristsDF<span style=color:#f92672>.</span>join<span style=color:#f92672>(</span>bandsDF<span style=color:#f92672>,</span> joinCondition<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;inner&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// right join
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>val</span> guitaristsBandsDF_right <span style=color:#66d9ef>=</span> guitaristsDF<span style=color:#f92672>.</span>join<span style=color:#f92672>(</span>bandsDF<span style=color:#f92672>,</span> joinCondition<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;right&#34;</span><span style=color:#f92672>)</span>
</span></span></code></pre></div><p>Without going into details, let’s define each join following the image above:</p><ul><li><strong>Left Join</strong>: combines rows from two tables based on a matching condition, including all rows from the left table and only matching rows from the right table. Any rows from the right table that don&rsquo;t have a match are filled with <code>NULL</code> values;</li><li><strong>Inner Join</strong>: take only the things that match on the left AND the right;</li><li><strong>Right Join</strong>: take everything on the right + anything on the left that matches;</li></ul><p>Here’s the result:</p><p><img loading=lazy src=images/Untitled%201.png alt=Untitled></p><p>Note that:</p><ul><li><code>left</code> type is equivalent to <code>left_outer</code> and <code>leftouter</code>;</li><li><code>right</code> type is equivalent to <code>right_outer</code> and <code>rightouter</code>.</li></ul><h2 id=32-full-outer-join>3.2. Full-Outer Join<a hidden class=anchor aria-hidden=true href=#32-full-outer-join>#</a></h2><p>In Full outer join we’ll take everything in the inner join + all the rows in the BOTH table, with <code>NULL</code> where the data is missing:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>val</span> guitaristsBandsDF_full_outer <span style=color:#66d9ef>=</span> guitaristsDF<span style=color:#f92672>.</span>join<span style=color:#f92672>(</span>bandsDF<span style=color:#f92672>,</span> joinCondition<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;full_outer&#34;</span><span style=color:#f92672>)</span>
</span></span></code></pre></div><p>Here’s the result:</p><p><img loading=lazy src=images/Untitled%202.png alt=Untitled></p><p>Note that:</p><ul><li><code>full_outer</code> type is equivalent to <code>outer</code> and <code>fullouter</code> and <code>full</code>.</li></ul><h2 id=33-left-semi-join>3.3. Left-Semi Join<a hidden class=anchor aria-hidden=true href=#33-left-semi-join>#</a></h2><p>It&rsquo;s like an inner join, but it also cut out the columns from the RIGHT DataFrame:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>val</span> guitaristsBandsDF_left_semi <span style=color:#66d9ef>=</span> guitaristsDF<span style=color:#f92672>.</span>join<span style=color:#f92672>(</span>bandsDF<span style=color:#f92672>,</span> joinCondition<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;left_semi&#34;</span><span style=color:#f92672>)</span>
</span></span></code></pre></div><p>Here’s the result:</p><p><img loading=lazy src=images/Untitled%203.png alt=Untitled></p><p>Note that:</p><ul><li><code>left_semi</code> type is equivalent to <code>leftsemi</code> and <code>semi</code>.</li></ul><h2 id=34-left-anti-join>3.4. Left-Anti Join<a hidden class=anchor aria-hidden=true href=#34-left-anti-join>#</a></h2><p>It keeps the rows in the LEFT DataFrame for which there is no row RIGHT DataFrame satisfying the join condition:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>val</span> guitaristsBandsDF_left_anti <span style=color:#66d9ef>=</span> guitaristsDF<span style=color:#f92672>.</span>join<span style=color:#f92672>(</span>bandsDF<span style=color:#f92672>,</span> joinCondition<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;left_anti&#34;</span><span style=color:#f92672>)</span>
</span></span></code></pre></div><p>Here’s the result:</p><p><img loading=lazy src=images/Untitled%204.png alt=Untitled></p><p>Note that:</p><ul><li><code>left_anti</code> type is equivalent to <code>leftanti</code> and <code>anti</code>.</li></ul><h1 id=4-potential-problems>4. Potential Problems<a hidden class=anchor aria-hidden=true href=#4-potential-problems>#</a></h1><p>Let’s consider <code>guitaristsBandsDF_left</code> DataFrame and let’s show it again here to better understand the problem:</p><p><img loading=lazy src=images/Untitled%205.png alt=Untitled></p><p>If we want to select only <code>id</code> and <code>band</code> (from left table):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>guitaristsBandsDF_left<span style=color:#f92672>.</span>select<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;band&#34;</span><span style=color:#f92672>).</span>show<span style=color:#f92672>()</span>
</span></span></code></pre></div><p>we’ll got an error because after the join there will be two <code>id</code> columns.</p><p>Solutions:</p><ol><li><p><strong>rename the column on which we are joining</strong> so that the two keys has now the same name:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>val</span> guitaristsBandsDF_left_v2 <span style=color:#66d9ef>=</span> guitaristsDF<span style=color:#f92672>.</span>join<span style=color:#f92672>(</span>bandsDF<span style=color:#f92672>.</span>withColumnRenamed<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;band&#34;</span><span style=color:#f92672>),</span> <span style=color:#e6db74>&#34;band&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;left&#34;</span><span style=color:#f92672>)</span>
</span></span></code></pre></div></li><li><p><strong>drop the duplicate column</strong> after the join:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>val</span> guitaristsBandsDF_left_v3 <span style=color:#66d9ef>=</span> guitaristsDF<span style=color:#f92672>.</span>join<span style=color:#f92672>(</span>bandsDF<span style=color:#f92672>,</span> joinCondition<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;left&#34;</span><span style=color:#f92672>).</span>drop<span style=color:#f92672>(</span>bandsDF<span style=color:#f92672>.</span>col<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>))</span>
</span></span></code></pre></div></li><li><p><strong>rename the offending column</strong> before the join:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>val</span> bandsModDF <span style=color:#66d9ef>=</span> bandsDF<span style=color:#f92672>.</span>withColumnRenamed<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;bandId&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> guitaristsBandsDF_left_v4 <span style=color:#66d9ef>=</span> guitaristsDF<span style=color:#f92672>.</span>join<span style=color:#f92672>(</span>bandsModDF<span style=color:#f92672>,</span> guitaristsDF<span style=color:#f92672>.</span>col<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;band&#34;</span><span style=color:#f92672>)===</span>bandsModDF<span style=color:#f92672>.</span>col<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;bandId&#34;</span><span style=color:#f92672>),</span> <span style=color:#e6db74>&#34;left&#34;</span><span style=color:#f92672>)</span>
</span></span></code></pre></div></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://simdangelo.github.io/tags/coding/>Coding</a></li><li><a href=https://simdangelo.github.io/tags/spark/>Spark</a></li><li><a href=https://simdangelo.github.io/tags/tutorial/>Tutorial</a></li></ul><nav class=paginav><a class=prev href=https://simdangelo.github.io/blog/mapping-my-learning-journey/><span class=title>« Prev</span><br><span>Mapping My Learning Journey: Priorities for the Weeks Ahead</span>
</a><a class=next href=https://simdangelo.github.io/blog/spark-dataframe-api-functions/><span class=title>Next »</span><br><span>#8 DataFrame API#2: Columns, Expressions, and Functions</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://simdangelo.github.io/>SimoneDangelo Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>